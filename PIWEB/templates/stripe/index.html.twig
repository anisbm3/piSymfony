{% extends 'front.html.twig' %}

    {% block body %}
        <div class="container">
            <h1>Paiement des Produits</h1>
    
            <!-- Affichage des produits et du total -->
            <table class="table">
                <thead>
                    <tr>
                        <th>Produit</th>
                        <th>Quantité</th>
                        <th>Prix</th>
                    </tr>
                </thead>
                <tbody>
                    {% for produit in produits %}
                        <tr>
                            <td>{{ produit.prod_name }}</td>
                            <td>{{ produit.quantity }}</td>
                            <td>{{ produit.price }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
            <div>
                <p>Total à payer : {{ totalPrice }} €</p>
            </div>
    
            <!-- Formulaire de paiement Stripe -->
            <form id="payment-form" action="{{ path('stripe_charge') }}" method="POST">
                <div class="form-group">
                    <label for="cardholder-name">Nom du titulaire de la carte</label>
                    <input type="text" id="cardholder-name" name="cardholder_name" class="form-control" placeholder="Nom complet" required>
                </div>
    
                <div class="form-group">
                    <label for="card-element">Numéro de carte</label>
                    <div id="card-element"></div>
                    <div id="card-errors" role="alert"></div>
                </div>
    
                <div class="form-group">
                    <label for="card-expiry">Date d'expiration</label>
                    <input type="text" id="card-expiry" name="card_expiry" class="form-control" placeholder="MM/AA" required>
                </div>
    
                <div class="form-group">
                    <label for="card-cvc">Code de sécurité (CVC)</label>
                    <input type="text" id="card-cvc" name="card_cvc" class="form-control" placeholder="CVC" required>
                </div>
    
                <!-- Champ caché pour le montant -->
                <input type="hidden" id="montant_total" name="montant_total" value="{{ totalPrice * 100 }}">
    
                <button id="submit-button" class="btn btn-primary">Payer {{ totalPrice }} €</button>
            </form>
        </div>
    
        <!-- Inclure le script de l'API Stripe -->
        <script src="https://js.stripe.com/v3/"></script>
    
        <!-- Votre script JavaScript pour gérer le paiement -->
        <script>
            var stripe = Stripe("{{'pk_test_51OphDrASsnDruPyJX2OalNMOju1tFjPnPhY4QvHVOswrsC309XLyZdNEwAxzCveIEXGvezcvzSyui2bFHqkWvY0X001M4Vqd1Y'}}");
            var elements = stripe.elements();
            var cardElement = elements.create('card');
            cardElement.mount('#card-element');
    
            var form = document.getElementById('payment-form');
            var submitButton = document.getElementById('submit-button');
    
            form.addEventListener('submit', function(event) {
                event.preventDefault();
                stripe.createPaymentMethod({
                    type: 'card',
                    card: cardElement,
                    billing_details: {
                        name: document.getElementById('cardholder-name').value
                    }
                }).then(function(result) {
                    if (result.error) {
                        var errorElement = document.getElementById('card-errors');
                        errorElement.textContent = result.error.message;
                    } else {
                        // Envoyer le montant total avec le paiement
                        var montantTotal = document.getElementById('montant_total').value;
                        var cardholderName = document.getElementById('cardholder-name').value;
                        fetch("{{ path('stripe_charge') }}", {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                stripeToken: result.paymentMethod.id,
                                montant_total: montantTotal,
                                cardholder_name: cardholderName,
                            })
                        }).then(function(response) {
                            return response.json();
                        }).then(function(data) {
                            // Gérer la réponse
                            console.log(data);
                            if (data.success) {
                                alert(data.message);
                                // Rediriger ou faire autre chose après le paiement réussi
                            } else {
                                alert('Erreur lors du paiement : ' + data.message);
                            }
                        }).catch(function(error) {
                            console.error('Erreur :', error);
                        });
                    }
                });
            });
        </script>
    {% endblock %}
    